(()=>{var e={};e.id=2647,e.ids=[1725,2647],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7714:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>v,routeModule:()=>g,serverHooks:()=>y,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{GET:()=>l});var a=s(59743),o=s(23112),n=s(2567),i=s(85454),u=s(78286);async function l(e){try{let t=await (0,u.createClient)(),{data:{user:s}}=await t.auth.getUser();if(!s)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{data:r}=await t.from("profiles").select("role").eq("id",s.id).single();if(!r||"admin"!==r.role&&"super_admin"!==r.role)return i.NextResponse.json({error:"Forbidden"},{status:403});let{searchParams:a}=new URL(e.url),o=a.get("type")||"comprehensive",n=a.get("time_range")||"30d",l=a.get("format")||"json",g=new Date,h=new Date;switch(n){case"7d":h.setDate(g.getDate()-7);break;case"30d":default:h.setDate(g.getDate()-30);break;case"90d":h.setDate(g.getDate()-90)}let f={};switch(o){case"user_analytics":f=await c(t,h);break;case"volunteer_hours":f=await _(t,h);break;case"tutoring_sessions":f=await d(t,h);break;case"messaging_analytics":f=await m(t,h);break;default:f=await p(t,h)}if(f.metadata={export_type:o,time_range:n,generated_at:new Date().toISOString(),generated_by:s.id},"csv"===l)return function(e,t){var s,r,a,o,n;let u="";switch(t){case"user_analytics":let l;s=e,l="User ID,Email,Full Name,Role,Status,Created At\n",s.users?.forEach(e=>{l+=`${e.id},${e.email},${e.full_name},${e.role},${e.status},${e.created_at}
`}),u=l;break;case"volunteer_hours":let c;r=e,c="ID,User ID,Activity Type,Activity Date,Hours,Status,Created At\n",r.volunteer_hours?.forEach(e=>{c+=`${e.id},${e.user_id},${e.activity_type},${e.activity_date},${e.hours},${e.status},${e.created_at}
`}),u=c;break;case"tutoring_sessions":let _;a=e,_="ID,Tutor ID,Student ID,Subject,Topic,Scheduled Date,Status,Created At\n",a.tutoring_sessions?.forEach(e=>{_+=`${e.id},${e.tutor_id},${e.student_id},${e.subject},${e.topic},${e.scheduled_date},${e.status},${e.created_at}
`}),u=_;break;case"messaging_analytics":let d;o=e,d="Message ID,Channel ID,Sender ID,Content,Created At\n",o.messages?.forEach(e=>{d+=`${e.id},${e.channel_id},${e.sender_id},${e.content},${e.created_at}
`}),u=d;break;default:let m;n=e,u=m=`Metric,Value
Total Users,${n.platform_summary.total_users}
Total Volunteer Hours,${n.platform_summary.total_volunteer_hours}
Total Tutoring Sessions,${n.platform_summary.total_tutoring_sessions}
Total Messages,${n.platform_summary.total_messages}
Platform Engagement Score,${n.platform_summary.platform_engagement_score}
`}return new i.NextResponse(u,{headers:{"Content-Type":"text/csv","Content-Disposition":`attachment; filename="${t}_${new Date().toISOString().split("T")[0]}.csv"`}})}(f,o);return i.NextResponse.json({success:!0,data:f})}catch(e){return console.error("Error exporting analytics:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e,t){let[{data:s},{data:r},{data:a}]=await Promise.all([e.from("profiles").select("*").gte("created_at",t.toISOString()),e.from("profiles").select("created_at, role, status").gte("created_at",t.toISOString()),e.from("analytics_events").select("*").gte("created_at",t.toISOString())]);return{users:s||[],user_growth:r||[],user_activity:a||[],summary:{total_users:s?.length||0,new_users:s?.filter(e=>new Date(e.created_at)>t).length||0,active_users:s?.filter(e=>"active"===e.status).length||0}}}async function _(e,t){let[{data:s},{data:r},{data:a}]=await Promise.all([e.from("volunteer_hours").select("*").gte("created_at",t.toISOString()),e.from("volunteer_hours").select("*").eq("status","approved").gte("created_at",t.toISOString()),e.from("volunteer_hours").select("*").eq("status","pending").gte("created_at",t.toISOString())]),o=r?.reduce((e,t)=>e+parseFloat(t.hours||0),0)||0;return{volunteer_hours:s||[],approved_hours:r||[],pending_hours:a||[],summary:{total_submissions:s?.length||0,approved_submissions:r?.length||0,pending_submissions:a?.length||0,total_hours:o,approval_rate:r?.length/s?.length*100||0}}}async function d(e,t){let[{data:s},{data:r},{data:a}]=await Promise.all([e.from("tutoring_sessions").select("*").gte("created_at",t.toISOString()),e.from("tutoring_sessions").select("*").eq("status","completed").gte("created_at",t.toISOString()),e.from("tutoring_sessions").select("*").eq("status","scheduled").gte("created_at",t.toISOString())]);return{tutoring_sessions:s||[],completed_sessions:r||[],scheduled_sessions:a||[],summary:{total_sessions:s?.length||0,completed_sessions:r?.length||0,scheduled_sessions:a?.length||0,completion_rate:r?.length/s?.length*100||0}}}async function m(e,t){let[{data:s},{data:r},{data:a}]=await Promise.all([e.from("chat_messages").select("*").gte("created_at",t.toISOString()),e.from("chat_channels").select("*").gte("created_at",t.toISOString()),e.from("chat_channel_members").select("*").gte("created_at",t.toISOString())]);return{messages:s||[],channels:r||[],channel_members:a||[],summary:{total_messages:s?.length||0,total_channels:r?.length||0,total_members:a?.length||0,avg_messages_per_channel:s?.length/r?.length||0}}}async function p(e,t){let[s,r,a,o]=await Promise.all([c(e,t),_(e,t),d(e,t),m(e,t)]);return{user_analytics:s,volunteer_hours:r,tutoring_sessions:a,messaging_analytics:o,platform_summary:{total_users:s.summary.total_users,total_volunteer_hours:r.summary.total_hours,total_tutoring_sessions:a.summary.total_sessions,total_messages:o.summary.total_messages,platform_engagement_score:function(e,t,s,r){let a=e.summary.active_users/e.summary.total_users*100,o=t.summary.approval_rate;return(a+o+s.summary.completion_rate+100*(r.summary.avg_messages_per_channel>0))/4}(s,r,a,o)}}}let g=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/analytics/export/route",pathname:"/api/analytics/export",filename:"route",bundlePath:"app/api/analytics/export/route"},resolvedPagePath:"/Users/yatishgrandhe/Downloads/Stem-Spark-main/app/api/analytics/export/route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:h,workUnitAsyncStorage:f,serverHooks:y}=g;function v(){return(0,n.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:f})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28187:()=>{},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50253:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56836:()=>{},60931:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=60931,e.exports=t},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78286:(e,t,s)=>{"use strict";s.d(t,{createClient:()=>o});var r=s(72831),a=s(62519);function o(){let e=(0,a.UL)();return(0,r.Ri)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:s,options:r})=>e.set(t,s,r))}catch{}}}})}},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81331:()=>{},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[1703,7893,9600],()=>s(7714));module.exports=r})();