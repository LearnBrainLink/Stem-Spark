(()=>{var e={};e.id=4487,e.ids=[1725,4487],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28187:()=>{},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50253:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56836:()=>{},60931:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=60931,e.exports=t},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},75651:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>l,serverHooks:()=>g,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>_});var s={};r.r(s),r.d(s,{GET:()=>c});var a=r(59743),o=r(23112),n=r(2567),i=r(85454),u=r(78286);async function c(e){try{var t,r,s,a,o;let n=await (0,u.createClient)(),{data:{user:c}}=await n.auth.getUser();if(!c)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{data:l}=await n.from("profiles").select("role").eq("id",c.id).single();if(!l||"admin"!==l.role&&"super_admin"!==l.role)return i.NextResponse.json({error:"Forbidden"},{status:403});let{searchParams:p}=new URL(e.url),_=p.get("time_range")||"30d",g=new Date,h=new Date;switch(_){case"7d":h.setDate(g.getDate()-7);break;case"30d":default:h.setDate(g.getDate()-30);break;case"90d":h.setDate(g.getDate()-90)}let[{count:v},{count:m},{count:x},{count:f},{count:q},{count:w},{count:S},{count:y},{count:D},{data:U},{data:b},{data:k},{data:O}]=await Promise.all([n.from("profiles").select("*",{count:"exact",head:!0}),n.from("profiles").select("*",{count:"exact",head:!0}).gte("created_at",h.toISOString()),n.from("profiles").select("*",{count:"exact",head:!0}).eq("status","active"),n.from("volunteer_hours").select("*",{count:"exact",head:!0}).eq("status","approved"),n.from("volunteer_hours").select("*",{count:"exact",head:!0}).eq("status","pending"),n.from("tutoring_sessions").select("*",{count:"exact",head:!0}),n.from("tutoring_sessions").select("*",{count:"exact",head:!0}).eq("status","completed"),n.from("chat_messages").select("*",{count:"exact",head:!0}),n.from("chat_channels").select("*",{count:"exact",head:!0}).eq("status","active"),n.from("profiles").select("created_at").gte("created_at",h.toISOString()).order("created_at",{ascending:!0}),n.from("volunteer_hours").select("created_at, hours").eq("status","approved").gte("created_at",h.toISOString()).order("created_at",{ascending:!0}),n.from("chat_messages").select("created_at").gte("created_at",h.toISOString()).order("created_at",{ascending:!0}),n.from("analytics_events").select("event_type, count").gte("created_at",h.toISOString()).order("count",{ascending:!1}).limit(10)]),A=d(U,"created_at",_),j=d(b,"created_at",_,"hours"),E=d(k,"created_at",_),R={user_retention_rate:function(e,t){if(!e||0===e.length)return 0;let r=e.length;return e.filter(e=>{let t=new Date(e.created_at),r=new Date;return r.setDate(r.getDate()-7),t>r}).length/r*100}(U,0),avg_session_duration:(t=b)&&0!==t.length?t.reduce((e,t)=>e+parseFloat(t.hours||0),0)/t.length:0,message_engagement:(r=k,s=v,r&&0!==s?new Set(r.map(e=>e.user_id)).size/s*100:0),volunteer_participation_rate:(a=b,o=v,a&&0!==o?new Set(a.map(e=>e.user_id)).size/o*100:0)};return i.NextResponse.json({success:!0,analytics:{overview:{total_users:v||0,new_users:m||0,active_users:x||0,total_volunteer_hours:f||0,pending_volunteer_hours:q||0,total_tutoring_sessions:w||0,completed_tutoring_sessions:S||0,total_messages:y||0,active_channels:D||0},trends:{user_growth:A,volunteer_hours:j,messaging_activity:E},engagement:R,conversions:{volunteer_hours_approval_rate:f/(f+q)*100,tutoring_completion_rate:S/w*100,user_activation_rate:x/v*100},top_events:O||[],time_range:_}})}catch(e){return console.error("Error fetching analytics dashboard:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}function d(e,t,r,s){return e&&0!==e.length?Object.values(e.reduce((e,r)=>{let a=new Date(r[t]).toISOString().split("T")[0];return e[a]||(e[a]={date:a,count:0,value:0}),e[a].count++,s&&(e[a].value+=parseFloat(r[s]||0)),e},{})).sort((e,t)=>e.date.localeCompare(t.date)):[]}let l=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/analytics/dashboard/route",pathname:"/api/analytics/dashboard",filename:"route",bundlePath:"app/api/analytics/dashboard/route"},resolvedPagePath:"/Users/yatishgrandhe/Downloads/Stem-Spark-main/app/api/analytics/dashboard/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:p,workUnitAsyncStorage:_,serverHooks:g}=l;function h(){return(0,n.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:_})}},78286:(e,t,r)=>{"use strict";r.d(t,{createClient:()=>o});var s=r(72831),a=r(62519);function o(){let e=(0,a.UL)();return(0,s.Ri)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:r,options:s})=>e.set(t,r,s))}catch{}}}})}},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81331:()=>{},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[1703,7893,9600],()=>r(75651));module.exports=s})();